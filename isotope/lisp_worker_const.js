const lispStringUrl = 'data:text/javascript;base64,Ly8gQSB0aW55IGxpc3AgZm9yIHNjcmlwdGluZyBwdXJwb3Nlcy4gU3luYyB3aXRoIGxpc3AuanMKLy8gRW11bGF0ZSBhIHN0YWNrIHRvIGF2b2lkIGluZmluaXRlIGxvb3BzLgoKLy8gVE9ETyAtIGZpbmlzaCBsYW5ndWFnZSBpbXBsZW1lbnRhdGlvbi4KCi8vIFZhbGlkIHR5cGVzCi8qCiAgdGFnZ2VkOgogIGV4cHIgIGZub3AgIG1hY3JvICAoZXJyb3IpCgogIG5hdGl2ZToKICBiaWdpbnQgIGF0b20gIGxpc3QgIG1hcCAgYm9vbCAgbnVsbAoqLwoKY29uc3QgYXJpdHkgPSB7CiAgLy8gQmluYXJ5CiAgJysnOiAyLCAnLSc6IDIsICcqJzogMiwgJy8nOiAyLCAnXic6IDIsICclJzogMiwKICAnPic6IDIsICc8JzogMiwgJz0nOiAyLCAnPj0nOiAyLCAnPD0nOiAyLCAnIT0nOiAyLAogICdiPDwnOiAyLCAnYj4+JzogMiwgJ2ImJzogMiwgJ2J8JzogMiwgJ2JeJzogMiwKICAvLyBVbmFyeQogICdific6IDEsICduZWcnOiAxLAogIC8vIExpc3QtbGlrZQogICdyYW5nZSc6IDIsICdlbnVtJzogMSwgJ21hcCc6IDIsICdmaWx0ZXInOiAyLCAnZm9sZGwnOiAzLCAnZm9sZHInOiAzLAogICdnZXQnOiAyLCAnc2V0JzogMywgJ2pvaW5hbGwnOiAxLCAnc2l6ZSc6IDEsICdzbGljZSc6IDMsCiAgJ2xpc3Q6JzogJ1ZBUklBQkxFJywgIC8vIGxpc3QgY29uc3RydWN0b3IKICAvLyBNYXAtbGlrZQogICdtYXAtPmxpc3QnOiAxLCAnbGlzdC0+bWFwJzogMSwKICAnbWFwOic6ICdWQVJJQUJMRScsICAvLyBtYXAgY29uc3RydWN0b3IKICAvLyBTeW1ib2xzCiAgJ3N5bS0+c3RyJzogMSwgJ3N0ci0+c3ltJzogMSwKICAnYXRvbT8nOiAxLCAnbGlzdD8nOiAxLCAnbWFwPyc6IDEsCiAgJ2xpc3QtPmNvbnMnOiAxLCAnY29ucy0+bGlzdCc6IDEsCn07CgpmdW5jdGlvbiBudW1lcmljRnVuY3Rpb24oZm4pIHsKICByZXR1cm4gKC4uLmFyZ3MpID0+IHsKICAgIGlmIChhcmdzLmV2ZXJ5KCh4KSA9PiB0eXBlb2YgeCA9PT0gJ2JpZ2ludCcpKSB7CiAgICAgIHJldHVybiBmbiguLi5hcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAnI2Vyci9uZWVkcy1udW1lcmljLWlucHV0cyc7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gYXRvbWljRnVuY3Rpb24oZm4pIHsKICByZXR1cm4gKC4uLmFyZ3MpID0+IHsKICAgIGlmIChhcmdzLmV2ZXJ5KGlzQXRvbWljKSkgewogICAgICByZXR1cm4gZm4oLi4uYXJncyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJyNlcnIvbmVlZHMtYXRvbWljLWlucHV0cyc7CiAgICB9CiAgfTsKfQoKY29uc3Qgb3BlcmF0b3JzID0gewogIC8vIEJpbmFyeQogICcrJzogbnVtZXJpY0Z1bmN0aW9uKChhLCBiKSA9PiBhICsgYiksCiAgJy0nOiBudW1lcmljRnVuY3Rpb24oKGEsIGIpID0+IGEgLSBiKSwKICAnKic6IG51bWVyaWNGdW5jdGlvbigoYSwgYikgPT4gYSAqIGIpLAogICcvJzogbnVtZXJpY0Z1bmN0aW9uKChhLCBiKSA9PiBiID09PSAwbiA/ICcjZXJyL2Rpdi0wJyA6IGEgLyBiKSwKICAnJSc6IG51bWVyaWNGdW5jdGlvbigoYSwgYikgPT4gYiA9PT0gMG4gPyAnI2Vyci9tb2QtMCcgOiBhICUgYiksCiAgJ14nOiBudW1lcmljRnVuY3Rpb24oKGEsIGIpID0+IGEgKiogYiksCiAgJz4nOiBhdG9taWNGdW5jdGlvbigoYSwgYikgPT4gYSA+IGIpLAogICc8JzogYXRvbWljRnVuY3Rpb24oKGEsIGIpID0+IGEgPCBiKSwKICAnPSc6IGF0b21pY0Z1bmN0aW9uKChhLCBiKSA9PiBhID09PSBiKSwKICAnPj0nOiBhdG9taWNGdW5jdGlvbigoYSwgYikgPT4gYSA+PSBiKSwKICAnPD0nOiBhdG9taWNGdW5jdGlvbigoYSwgYikgPT4gYSA8PSBiKSwKICAnIT0nOiBhdG9taWNGdW5jdGlvbigoYSwgYikgPT4gYSAhPT0gYiksCiAgJ2I8PCc6IG51bWVyaWNGdW5jdGlvbigoYSwgYikgPT4gYSA8PCBiKSwKICAnYj4+JzogbnVtZXJpY0Z1bmN0aW9uKChhLCBiKSA9PiBhID4+IGIpLAogICdiJic6IG51bWVyaWNGdW5jdGlvbigoYSwgYikgPT4gYSAmIGIpLAogICdifCc6IG51bWVyaWNGdW5jdGlvbigoYSwgYikgPT4gYSB8IGIpLAogICdiXic6IG51bWVyaWNGdW5jdGlvbigoYSwgYikgPT4gYSBeIGIpLAogIC8vIFVuYXJ5CiAgJ2J+JzogbnVtZXJpY0Z1bmN0aW9uKChhKSA9PiB+YSksCiAgJ25lZyc6IG51bWVyaWNGdW5jdGlvbigoYSkgPT4gLWEpLAogIC8vIExpc3QtbGlrZQogICdyYW5nZSc6IG51bWVyaWNGdW5jdGlvbigoYSwgYikgPT4gewogICAgY29uc3QgYW5zID0gW107CiAgICBmb3IgKGxldCBpID0gYTsgaSA8IGI7IGkrKykgYW5zLnB1c2goaSk7CiAgICByZXR1cm4gYW5zOwogIH0pLAogICdlbnVtJzogKGxpc3QpID0+IHsKICAgIGlmICghIGlzTGlzdChsaXN0KSkgcmV0dXJuICcjZXJyL2VudW0tbm9uLWxpc3QnOwogICAgY29uc3QgYW5zID0gW107CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpc3QubGVuZ3RoOyBpKyspIGFucy5wdXNoIChbW2ksIGxpc3RbaV1dXSk7CiAgfSwKICAvLyBUT0RPOiBmaXggYWxsIHRoaW5ncyB3aXRoIGZ1bmN0aW9ucy4KICAnbWFwJzogKGYsIGxpc3QpID0+IGxpc3QubWFwKChlKSA9PiBsaXNwQXBwbHkoZiwgW2VdKSksCiAgJ2ZpbHRlcic6IChmLCBsaXN0KSA9PiBsaXN0LmZpbHRlcigoZSkgPT4gbGlzcEFwcGx5KGYsIFtlXSkpLAogICdmb2xkbCc6IChmLCBzZWVkLCBsaXN0KSA9PiB7CiAgICBmb3IgKGNvbnN0IHkgb2YgbGlzdCkgc2VlZCA9IGxpc3BBcHBseShmLCBbc2VlZCwgeV0pOwogICAgcmV0dXJuIHNlZWQ7CiAgfSwKICAnZm9sZHInOiAoZiwgc2VlZCwgbGlzdCkgPT4gewogICAgZm9yIChsZXQgaSA9IGxpc3QubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgY29uc3QgeSA9IGxpc3RbaV07CiAgICAgIHNlZWQgPSBsaXNwQXBwbHkoZiwgW3NlZWQsIHldKTsKICAgIH0KICAgIHJldHVybiBzZWVkOwogIH0sCiAgJ2dldCc6IChpbmQsIGxpc3QpID0+IHsKICAgIGlmIChsaXN0IGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgcmV0dXJuIGxpc3RbaW5kXSA/PyBudWxsOwogICAgfSBlbHNlIGlmIChsaXN0IGluc3RhbmNlb2YgTWFwKSB7CiAgICAgIHJldHVybiBsaXN0LmdldChpbmQpID8/IG51bGw7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gJyNlcnIvYXR0ZW1wdGVkLWdldCc7CiAgICB9CiAgfSwKICAnc2V0JzogKGluZCwgZWxlbSwgbGlzdCkgPT4gewogICAgaWYgKGxpc3QgaW5zdGFuY2VvZiBBcnJheSkgewogICAgICBpZiAoaW5kID49IE51bWJlcihsaXN0Lmxlbmd0aCkpIHsKICAgICAgICByZXR1cm4gbGlzdC5jb25jYXQoW2VsZW1dKTsKICAgICAgfSBlbHNlIGlmIChpbmQgPCAwbikgewogICAgICAgIHJldHVybiBbZWxlbV0uY29uY2F0KGxpc3QpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFucyA9IFsuLi5saXN0XTsKICAgICAgICBhbnNbaW5kXSA9IGVsZW07CiAgICAgICAgcmV0dXJuIGFuczsKICAgICAgfQogICAgfSBlbHNlIGlmIChsaXN0IGluc3RhbmNlb2YgTWFwKSB7CiAgICAgIGNvbnN0IGFucyA9IG5ldyBNYXAobGlzdCk7CiAgICAgIGFucy5zZXQoaW5kLCBlbGVtKTsKICAgICAgcmV0dXJuIGFuczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiAnI2Vyci9hdHRlbXB0ZWQtc2V0JzsKICAgIH0KICB9LAogICdzbGljZSc6IChmcm9tLCB0bywgbGlzdCkgPT4gewogICAgaWYgKGZyb20gaW5zdGFuY2VvZiBCaWdJbnQgJiYgdG8gaW5zdGFuY2VvZiBCaWdJbnQgJiYgaXNMaXN0KGxpc3QpKQogICAgICByZXR1cm4gbGlzdC5zbGljZShOdW1iZXIoZnJvbSksIE51bWJlcih0bykpOwogICAgZWxzZSByZXR1cm4gJyNlcnIvYXR0ZW1wdGVkLXNsaWNlJzsKICB9LAogICdqb2luYWxsJzogKGxpc3RPZkxpc3RzKSA9PiB7CiAgICBpZiAoISBpc0xpc3QobGlzdE9mTGlzdHMpKSByZXR1cm4gJyNlcnIvYXR0ZW1wdGVkLWpvaW5hbGwnOwogICAgY29uc3QgYW5zID0gW107CiAgICBmb3IgKGNvbnN0IGxpc3Qgb2YgbGlzdE9mTGlzdHMpIHsKICAgICAgaWYgKGlzTGlzdChsaXN0KSkgZm9yIChjb25zdCB5IG9mIGxpc3QpIHsKICAgICAgICBhbnMucHVzaCAoeSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhbnM7CiAgfSwKICAnc2l6ZSc6IChsaXN0KSA9PiB7CiAgICBpZiAobGlzdCBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgIHJldHVybiBCaWdJbnQobGlzdC5sZW5ndGgpOwogICAgfSBlbHNlIGlmIChsaXN0IGluc3RhbmNlb2YgTWFwKSB7CiAgICAgIHJldHVybiBCaWdJbnQobGlzdC5zaXplKTsKICAgIH0gZWxzZSByZXR1cm4gJyNlcnIvc2l6ZW9mLW5vbi1jb2xsZWN0aW9uJzsKICB9LAogICdsaXN0Oic6ICguLi5hcmdzKSA9PiBhcmdzLAogICdtYXAtPmxpc3QnOiAobSkgPT4gWy4uLm1dLAogICdsaXN0LT5tYXAnOiAobCkgPT4gbmV3IE1hcChsKSwKICAnbWFwOic6ICguLi5hcmdzKSA9PiB7CiAgICBjb25zdCBhbnMgPSBuZXcgTWFwKCk7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgYW5zLnNldChhcmdzW2ldLCBhcmdzW2krMV0pOwogICAgfQogICAgcmV0dXJuIGFuczsKICB9LAogICdzeW0tPnN0cic6IChzeW0pID0+IFsuLi5zeW1dLm1hcCgoeCkgPT4gQmlnSW50KHguY29kZVBvaW50QXQoMCkpKSwKICAnc3RyLT5zeW0nOiAoc3RyKSA9PiBzdHIubWFwKCh4KSA9PiBTdHJpbmcuZnJvbUNvZGVQb2ludChOdW1iZXIoeCkpKS5qb2luKCcnKSwKICAnbGlzdC0+Y29ucyc6IChsaXN0KSA9PiB7CiAgICBpZiAoISBpc0xpc3QobGlzdCkpIHJldHVybiAnI2Vyci9saXN0LT5jb25zLW5vbi1saXN0JzsKICAgIGxldCBhbnMgPSBudWxsOwogICAgZm9yIChsZXQgaSA9IGxpc3QubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIGFucyA9IFtsaXN0W2ldLCBhbnNdOwogICAgcmV0dXJuIGFuczsKICB9LAogICdjb25zLT5saXN0JzogKGNvbnMpID0+IHsKICAgIGxldCBhbnMgPSBbXSwgaGVhZCA9IGNvbnM7CiAgICB3aGlsZShpc0xpc3QoaGVhZCkgJiYgaGVhZC5sZW5ndGggPT09IDIpIHsKICAgICAgYW5zLnB1c2goaGVhZFswXSk7CiAgICAgIGhlYWQgPSBoZWFkWzFdOwogICAgfQogICAgcmV0dXJuIGFuczsKICB9LAogICdhdG9tPycgOiBpc0F0b21pYywKICAnbGlzdD8nIDogaXNMaXN0LAogICdtYXA/JyA6IGlzTWFwLAp9OwoKY29uc3QgYnVpbHRpbkZ1bmN0aW9ucyA9IG5ldyBTZXQoT2JqZWN0LmtleXMob3BlcmF0b3JzKSk7CgovLyBBbHRlcm5hdGUgZnJhbWUgc3RydWN0dXJlOgovLyBbdHlwZSBmb3JtIGVudiBzdWJpbmRleF0KLy8gZW52IG1heSBiZSBudWxsIGZvciBsaXRlcmFscwovLyBzdWJpbmRleCBtYXkgYmUgbnVsbCBmb3IgdGhvc2UgdGhhdCB3b24ndCBtYXR0ZXIKCi8vIFN0YWNrOgovLyBbZnJhbWUgLi4uXQovLyBFYWNoIGZyYW1lOgovLyBbZXhwciBmb3JtIGVudiAtXSA6OiBiZWZvcmUgZXZhbHVhdGlvbgovLyBbZm5vcCBmb3JtIGVudiBpbmRleF0gOjogZHVyaW5nIGV2YWx1YXRpb24KLy8gTm90aWNlISBGb3IgYSBmbm9wIGxpa2UgKCsgeCB5KSwgYXJncyBpcyBbKywgeCwgeV0sIGJlY2F1c2UgdGhlIGZ1bmN0aW9uIGhlYWQgaGFzIHRvIGJlIGV2YWx1YXRlZCB0b28uCi8vIFttYWNybyBmb3JtIGVudiBpbmRleF0gLSBpZiwgbGV0LCBsZXRyZWMsIGFuZCwgb3IKLy8gW2xpdGVyYWwgZm9ybSAtIC1dIC0gYWZ0ZXIgZXhwYW5zaW9uCi8vIFtjbG9zdXJlIGZvcm0gZW52IC1dIC0gbGFtYmRhIGNsb3N1cmUsIGNhbm5vdCBleHBhbmQgZnVydGhlcgovLyBbZXJyb3IgcmVhc29uIC0gLV0gLSBlcnJvciwgc3RvcHBpbmcgdGhlIGV2YWx1YXRpb24KLy8KLy8gR2VuZXJhbCBzdGFjayBzdHJ1Y3R1cmU6Ci8vIFtmbm9wL21hY3JvIC4gZm5vcC9tYWNybyAuIC4gLiBmbm9wL21hY3JvIC4gPGFueT5dCgovKgogIFN0cnVjdHVyZSBvZiBhIGdlbmVyYWwgcHJvZ3JhbS4KICBhdG9tIDogYXRvbWljIGxpdGVyYWxzCiAgKGZuIC4uLmFyZ3MpIDogZnVuY3Rpb24gYXBwbGljYXRpb24KICAoYXBwbHkgZm4gbGlzdCkgOiBhcHBseSBsaXN0CiAgKGxpc3QgLi4uYXJncykgOiBsaXN0IGdlbmVyYXRpb24KICAoJyB4KSA6IGxpdGVyYWwKICAoW2FuZCwgb3JdIC4uLmFyZ3MpIDogYm9vbGVhbiBvcGVyYXRpb24KICAoaWYgcDEgYTEgcDIgYTIgcDMgYTMgLi4uIHBuIGFuIHhuKSA6IGNvbmQKICAobGV0IHgxIHkxIHgyIHkyIC4uLiB4biB5biBib2R5KSA6IGxldAogIChsZXRyZWMgeDEgZjEgeDIgZjIgLi4uIHhuIGZuIGJvZHkpIDogbGV0IHJlY3Vyc2l2ZQogICg6IGFyZ2xpc3QgYm9keSkgOiBmdW5jdGlvbiB3aXRoIGFyZ3VtZW50IGxpc3QKICAoZ2V0IG50aCBsaXN0KSwgKHNldCBudGggbGlzdCBvYmopIDogbGlzdCBvcGVyYXRpb24KCiAgSWRlYWxseSBidWlsdC1pbiB0aGluZ3M6IG1hcCwgZmlsdGVyLCBmb2xkKGwvcikKKi8KCmZ1bmN0aW9uIHN0ZXBTdGFjayAoc3RhY2spIHsKICBjb25zdCBmcmFtZSA9IHN0YWNrLnBvcCAoKTsKICAvLyBpZiAodmFsVHlwZShmcmFtZSkgPT09IG51bGwpIHtzdGFjay5wdXNoKGZyYW1lKTsgcmV0dXJuO30KICBjb25zdCB0eXBlID0gdmFsVHlwZShmcmFtZSk7CiAgbGV0IGZvcm0gPSBudWxsLCBlbnYgPSBudWxsLCBzdWJpbmRleCA9IG51bGw7CiAgaWYgKGlzQ29tcG91bmRGcmFtZShmcmFtZSkpIHsKICAgIGZvcm0gPSBmcmFtZS5mb3JtOyBlbnYgPSBmcmFtZS5lbnY7IHN1YmluZGV4ID0gZnJhbWUuc3ViaW5kZXg7CiAgfQogIC8vIEhhbmRsZSBlYWNoIGNhc2UuCiAgaWYgKHR5cGUgPT09ICdleHByJykgewogICAgaWYgKCEgaXNMaXN0KGZvcm0pKSB7CiAgICAgIC8vIEF0b20KICAgICAgaWYgKHR5cGVvZiBmb3JtICE9PSAnc3RyaW5nJykgewogICAgICAgIC8vIExpdGVyYWwKICAgICAgICBzdGFjay5wdXNoIChmb3JtKTsKICAgICAgfSBlbHNlIGlmIChbJ3RydWUnLCAnZmFsc2UnXS5pbmNsdWRlcyhmb3JtKSkgewogICAgICAgIHN0YWNrLnB1c2ggKGZvcm0gPT09ICd0cnVlJyk7CiAgICAgIH0gZWxzZSBpZiAoZm9ybS5tYXRjaCAoL15bKy1dP1swLTldKyQvKSkgeyAgLy8gTnVtYmVyCiAgICAgICAgc3RhY2sucHVzaCAoQmlnSW50KGZvcm0pKTsKICAgICAgfSBlbHNlIGlmIChmb3JtLnN0YXJ0c1dpdGggKCcjJykpIHsgIC8vIFN5bWJvbAogICAgICAgIHN0YWNrLnB1c2ggKGZvcm0pOwogICAgICB9IGVsc2UgaWYgKGJ1aWx0aW5GdW5jdGlvbnMuaGFzIChmb3JtKSkgewogICAgICAgIHN0YWNrLnB1c2ggKGZvcm0pOyAgLy8gQnVpbHQtaW4gZnVuY3Rpb24uCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTG9vayB1cCBpbiBlbnZpcm9ubWVudC4KICAgICAgICBpZiAoISBlbnYuaGFzKGZvcm0pKSB7CiAgICAgICAgICBzdGFjay5wdXNoKGZyYW1lKTsKICAgICAgICAgIHN0YWNrLnB1c2goJyNlcnIvdmFyLXVuZm91bmQnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc3RhY2sucHVzaCAoZW52LmdldChmb3JtKSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGZvcm0ubGVuZ3RoIDw9IDApIHsKICAgICAgc3RhY2sucHVzaCAoW10pOwogICAgfSBlbHNlIHsKICAgICAgY29uc3QgaGVhZCA9IGZvcm1bMF07CiAgICAgIGlmIChbJ2lmJywgJ2xldCcsICInIl0uaW5jbHVkZXMgKGhlYWQpKSB7CiAgICAgICAgLy8gTWFjcm8uCiAgICAgICAgc3RhY2sucHVzaCAoe3R5cGU6ICdtYWNybycsIGZvcm06IFsuLi4gZm9ybV0sIGVudiwgc3ViaW5kZXg6IDF9KTsKICAgICAgfSBlbHNlIGlmIChbJzonXS5pbmNsdWRlcyhoZWFkKSkgewogICAgICAgIC8vIEZ1bmN0aW9uIGRlZmluaXRpb24uCiAgICAgICAgY29uc3QgW19jb2xvbiwgZm52YXJzLCBmbmJvZHksIGZuY2FwdHVyZXNdID0gZm9ybTsKICAgICAgICBjb25zdCBuZXdFbnYgPSBuZXcgTWFwKCk7CiAgICAgICAgZm9yIChjb25zdCB2YXJOYW1lIG9mIChmbmNhcHR1cmVzIHx8IFtdKSkgewogICAgICAgICAgbmV3RW52LnNldCh2YXJOYW1lLCBlbnYuZ2V0KHZhck5hbWUpKTsKICAgICAgICB9CiAgICAgICAgc3RhY2sucHVzaCAoW19jb2xvbiwgZm52YXJzLCBmbmJvZHksIG5ld0Vudl0pOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIEZ1bmN0aW9uIGFwcGxpY2F0aW9uLgogICAgICAgIHN0YWNrLnB1c2ggKHt0eXBlOiAnZm5vcCcsIGZvcm06IFsuLi4gZm9ybV0sIGVudiwgc3ViaW5kZXg6IDB9KTsKICAgICAgfQogICAgfQogIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Zub3AnKSB7CiAgICBpZiAoc3ViaW5kZXggPj0gZm9ybS5sZW5ndGgpIHsKICAgICAgY29uc3QgaGVhZCA9IGZvcm1bMF07CiAgICAgIGlmIChidWlsdGluRnVuY3Rpb25zLmhhcyhoZWFkKSkgewogICAgICAgIGNvbnN0IGFuc3dlciA9IG9wZXJhdG9yc1toZWFkXSguLi4gZm9ybS5zbGljZSgxKSk7CiAgICAgICAgaWYgKGlzRXJyKGFuc3dlcikpIHN0YWNrLnB1c2goZnJhbWUpOwogICAgICAgIHN0YWNrLnB1c2ggKGFuc3dlcik7CiAgICAgIH0gZWxzZSBpZiAoaGVhZFswXSA9PT0gJzonICYmIGhlYWQubGVuZ3RoID49IDMpIHsKICAgICAgICAvLyBDdXN0b20tZGVmaW5lZCBmdW5jdGlvbgogICAgICAgIGNvbnN0IFtfY29sb24sIGZudmFycywgZm5ib2R5LCBmbmNhcHR1cmVzXSA9IGhlYWQ7CiAgICAgICAgY29uc3QgZW52ID0gZm5jYXB0dXJlcyA/IG5ldyBNYXAoZm5jYXB0dXJlcykgOiBuZXcgTWFwKCk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmbnZhcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGVudi5zZXQoZm52YXJzW2ldLCBmb3JtW2ldKTsKICAgICAgICB9CiAgICAgICAgc3RhY2sucHVzaCh7dHlwZTogJ2V4cHInLCBmb3JtOiBmbmJvZHksIGVudn0pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjb25zdCBzdWJmb3JtID0gZnJhbWUuZm9ybVtzdWJpbmRleF07CiAgICAgIGZyYW1lLmZvcm1bc3ViaW5kZXhdID0gJy53YWl0JzsKICAgICAgc3RhY2sucHVzaCAoZnJhbWUpOwogICAgICBzdGFjay5wdXNoICh7dHlwZTogJ2V4cHInLCBmb3JtOiBzdWJmb3JtLCBlbnZ9KTsKICAgIH0KICB9IGVsc2UgaWYgKHR5cGUgPT09ICdtYWNybycpIHsKICAgIGNvbnN0IGhlYWQgPSBmb3JtWzBdOwogICAgaWYgKGhlYWQgPT09ICdpZicpIHsKICAgICAgaWYgKGZvcm0ubGVuZ3RoICE9PSA0KSB7CiAgICAgICAgc3RhY2sucHVzaChmcmFtZSk7CiAgICAgICAgc3RhY2sucHVzaCgnI2Vyci9pZi1sZW5ndGgtZXJyb3InKTsKICAgICAgICByZXR1cm4gJ2RvbmUnOwogICAgICB9CiAgICAgIGlmIChzdWJpbmRleCA9PT0gMikgewogICAgICAgIC8vIENvbmQKICAgICAgICBpZiAoZm9ybVsxXSkgewogICAgICAgICAgLy8gRXZhbHVhdGVzIHRvIHZhbDEKICAgICAgICAgIHN0YWNrLnB1c2ggKHt0eXBlOiAnZXhwcicsIGZvcm06IGZvcm1bMl0sIGVudn0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBFdmFsdWF0ZXMgdG8gcmVzdAogICAgICAgICAgc3RhY2sucHVzaCAoe3R5cGU6ICdleHByJywgZm9ybTogZm9ybVszXSwgZW52fSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFVuZXZhbHVhdGVkIHlldAogICAgICAgIHN0YWNrLnB1c2ggKGZyYW1lKTsKICAgICAgICBzdGFjay5wdXNoICh7dHlwZTogJ2V4cHInLCBmb3JtOiBmb3JtWzFdLCBlbnZ9KTsKICAgICAgfQogICAgfSBlbHNlIGlmIChoZWFkID09PSAnbGV0JykgewogICAgICAvLyAobGV0IHggeSBleHByKQogICAgICBpZiAoZm9ybS5sZW5ndGggIT09IDQpIHsKICAgICAgICBzdGFjay5wdXNoKGZyYW1lKTsKICAgICAgICBzdGFjay5wdXNoKCcjZXJyL2xldC1sZW5ndGgtZXJyb3InKTsKICAgICAgICByZXR1cm4gJ2RvbmUnOwogICAgICB9CiAgICAgIGNvbnN0IFtfLCB4LCB5LCBleHByXSA9IGZvcm07CiAgICAgIGlmIChzdWJpbmRleCA9PT0gMSkgewogICAgICAgIC8vIGNvbXB1dGUgeSBmaXJzdAogICAgICAgIHN0YWNrLnB1c2goe3R5cGUsIGZvcm0sIGVudiwgc3ViaW5kZXg6IDJ9KTsKICAgICAgICBzdGFjay5wdXNoKHt0eXBlOiAnZXhwcicsIGZvcm06IHksIGVudiwgc3ViaW5kZXg6IDB9KTsKICAgICAgfSBlbHNlIGlmIChzdWJpbmRleCA9PT0gMikgewogICAgICAgIC8vIGNhbiBtb3ZlIGZvcndhcmQKICAgICAgICBjb25zdCBuZXh0RnJhbWUgPSB7dHlwZTogJ2V4cHInLCBmb3JtOiBleHByLCBlbnY6IHdpdGhWYWwoZW52LCB4LCB5KX07CiAgICAgICAgc3RhY2sucHVzaChuZXh0RnJhbWUpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGhlYWQgPT09ICInIikgewogICAgICBpZiAoZm9ybS5sZW5ndGggIT09IDIpIHsKICAgICAgICBzdGFjay5wdXNoKGZyYW1lKTsKICAgICAgICBzdGFjay5wdXNoKCIjZXJyLyctbGVuZ3RoLWVycm9yIik7CiAgICAgICAgcmV0dXJuICdkb25lJzsKICAgICAgfQogICAgICBzdGFjay5wdXNoIChmb3JtWzFdKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YWNrLnB1c2goZnJhbWUpOyBzdGFjay5wdXNoKCIjZXJyL3VucmVjb2duaXplZC1tYWNybyIpOwogICAgICByZXR1cm4gJ2RvbmUnOwogICAgfQogIH0gZWxzZSBpZiAoaXNFcnIoZnJhbWUpKSB7CiAgICBzdGFjay5wdXNoKGZyYW1lKTsKICAgIHJldHVybiAnZG9uZSc7CiAgfSBlbHNlIGlmIChpc0xpdGVyYWxGcmFtZSh0eXBlKSkgewogICAgLy8gRG9uZSwgZ28gdG8gcHJldmlvdXMgb25lCiAgICBjb25zdCB2YWx1ZSA9IGZyYW1lOwogICAgaWYgKHN0YWNrLmxlbmd0aCA+IDApIHsKICAgICAgY29uc3QgcGFyZW50ID0gc3RhY2tbc3RhY2subGVuZ3RoIC0gMV07CiAgICAgIGlmICghIFsnZm5vcCcsICdtYWNybyddLmluY2x1ZGVzKHBhcmVudC50eXBlKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvciAoJ0Vycm9yISBJbmNvcnJlY3QgcGFyZW50LnR5cGUnLCBwYXJlbnQudHlwZSwgc3RhY2spOwogICAgICAgIHJldHVybiAnZG9uZSc7CiAgICAgIH0KICAgICAgcGFyZW50LmZvcm1bcGFyZW50LnN1YmluZGV4XSA9IHZhbHVlOwogICAgICBpZiAocGFyZW50LnR5cGUgPT09ICdmbm9wJyB8fCBwYXJlbnQuZm9ybVswXSA9PT0gJ2lmJykgcGFyZW50LnN1YmluZGV4ICsrOwogICAgfSBlbHNlIHsKICAgICAgc3RhY2sucHVzaCAoZnJhbWUpOwogICAgICByZXR1cm4gJ2RvbmUnOwogICAgfQogIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2Vycm9yJykgewogICAgcmV0dXJuICdkb25lJzsKICB9IGVsc2UgewogICAgdGhyb3cgbmV3IEVycm9yICgnRXJyb3IhIFVucmVjb2duaXplZCBmcmFtZSB0eXBlLicpOwogIH0KfQoKZnVuY3Rpb24gZXZhbHVhdGUgKHNleHAsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICB2YXIgbGltaXQgPSBvcHRpb25zLmxpbWl0IHx8IDIwMDA7CiAgY29uc3Qgc2hvd1N0ZXBzID0gW3RydWUsIGZhbHNlXS5pbmNsdWRlcyhvcHRpb25zLnNob3dTdGVwcykgPyBvcHRpb25zLnNob3dTdGVwcyA6IHRydWU7CiAgY29uc3Qgc3RhY2sgPSBbewogICAgdHlwZTogJ2V4cHInLAogICAgZm9ybTogc2V4cCwKICAgIGVudjogb3B0aW9ucy5lbnYgfHwgbmV3IE1hcCgpLAogIH1dOwogIHdoaWxlIChsaW1pdCA+IDApIHsKICAgIGNvbnN0IHN0YXR1cyA9IHN0ZXBTdGFjayAoc3RhY2spOwogICAgaWYgKHN0YXR1cyA9PT0gJ2RvbmUnKSBicmVhazsKICAgIGxpbWl0LS07CgogICAgaWYgKHNob3dTdGVwcykgewogICAgICAvLyBjb25zb2xlLmxvZyAoZGlzcFN0YWNrKHN0YWNrKSk7CiAgICAgIC8vIGNvbnNvbGUubG9nIChlbGVtKCdocicpKTsKICAgIH0KICB9CiAgcmV0dXJuIHN0YWNrOwp9CgpmdW5jdGlvbiBpc0F0b20gKG9iaikgeyByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ3N0cmluZyc7IH0KCmZ1bmN0aW9uIGlzTGlzdCAob2JqKSB7IHJldHVybiBvYmogaW5zdGFuY2VvZiBBcnJheTsgfQoKZnVuY3Rpb24gaXNNYXAgKG9iaikgeyByZXR1cm4gb2JqIGluc3RhbmNlb2YgTWFwOyB9CgpmdW5jdGlvbiBpc051bGwgKG9iaikgeyByZXR1cm4gb2JqID09PSBudWxsIHx8IG9iaiA9PT0gdW5kZWZpbmVkOyB9CgpmdW5jdGlvbiBpc1ZhciAob2JqKSB7IHJldHVybiBpc0F0b20ob2JqKSAmJiBvYmouc3RhcnRzV2l0aCgnXycpOyB9CgpmdW5jdGlvbiBpc1N5bSAob2JqKSB7IHJldHVybiBpc0F0b20ob2JqKSAmJiBvYmouc3RhcnRzV2l0aCgnIycpOyB9CgpmdW5jdGlvbiBpc0VyciAob2JqKSB7IHJldHVybiBpc0F0b20ob2JqKSAmJiBvYmouc3RhcnRzV2l0aCgnI2Vyci8nKTsgfQoKZnVuY3Rpb24gZmluZFZhbCAoZW52LCBhdG9tKSB7IHJldHVybiBlbnYuZ2V0IChhdG9tKTsgfQoKZnVuY3Rpb24gaXNBdG9taWMgKHZhbCkgewogIHJldHVybiAhIChpc0xpc3QodmFsKSB8fCBpc01hcCh2YWwpKTsKfQoKZnVuY3Rpb24gaXNDb21wb3VuZEZyYW1lICh2YWwpIHsKICByZXR1cm4gWydtYWNybycsICdmbm9wJywgJ2V4cHInXS5pbmNsdWRlcyh2YWxUeXBlKHZhbCkpOwp9CgpmdW5jdGlvbiBpc0xpdGVyYWxGcmFtZSAodmFsKSB7IHJldHVybiAhIGlzQ29tcG91bmRGcmFtZSh2YWwpOyB9CgpmdW5jdGlvbiBpc0NvbXBsZXRlIChzdGFjaykgewogIHJldHVybiBzdGFjay5sZW5ndGggPT09IDEgJiYgKHN0YWNrWzBdLnR5cGUgfHwgbnVsbCA9PT0gbnVsbCk7Cn0KCmZ1bmN0aW9uIHdpdGhWYWwgKGVudiwga2V5LCB2YWwpIHsKICBjb25zdCBhbnMgPSBuZXcgTWFwKGVudik7CiAgYW5zLnNldChrZXksIHZhbCk7CiAgcmV0dXJuIGFuczsKfQoKLy8gUmV0dXJucyB0aGUgdHlwZSBvZiBhIHZhbHVlLgpmdW5jdGlvbiB2YWxUeXBlICh2YWwpIHsKICBpZiAoW3RydWUsIGZhbHNlLCBudWxsLCB1bmRlZmluZWRdLmluY2x1ZGVzKHZhbCkpIHsKICAgIHJldHVybiAnc3BlY2lhbCc7CiAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAnYmlnaW50JykgewogICAgcmV0dXJuICdiaWdpbnQnOwogIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiAnYXRvbSc7CiAgfSBlbHNlIGlmICh2YWwgaW5zdGFuY2VvZiBBcnJheSkgewogICAgcmV0dXJuICdsaXN0JzsKICB9IGVsc2UgaWYgKHZhbCBpbnN0YW5jZW9mIE1hcCkgewogICAgcmV0dXJuICdtYXAnOwogIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ29iamVjdCcpIHsKICAgIGlmICh0eXBlb2YgdmFsLnR5cGUgPT09ICdzdHJpbmcnKSByZXR1cm4gdmFsLnR5cGU7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvciAoYFVucmVjb2duaXplZCB0eXBlICR7dmFsfTogJHt0eXBlb2YgdmFsfWApOwogIH0KfQoKLy8gU3luYyB3aXRoIHByZXByby5qcwoKLy8gTGlzcCBwcmVwcm9jZXNzb3IuCgovKiogVE9ETyAtIFByZXByb2Nlc3NvciBmb3JtYXQKICAgIChwYXJ0MSB8IHBhcnQyIHwgLi4uIHwgcGFydG4pIDwtLSBpZ25vcmVkIGZvciBub3cuCiAgICA9PiAocGFydG4gKHBhcnRuLTEgLi4uIChwYXJ0MiBwYXJ0MSkpKQogICAgKHBhcnQxIEAgcGFydDIgQCAuLi4gQCBwYXJ0bikKICAgID0+IChwYXJ0MSAocGFydDIgLi4uIChwYXJ0bi0xIHBhcnRuKSkpCiAgICBpZiBfIGV4aXN0cywgcmVwbGFjZXMgXy4KCiAgICAoY29uZCBjMSBhMSBjMiBhMiAuLi4gY24gYW4pIDwtLSBjYW4gYmUgaWYgYzEgYTIgQCBpZiBjMiBhMiBAIC4uLgogICAgKGFuZCBjMSBjMiAuLi4gY24pCiAgICAob3IgYzEgYzIgLi4uIGNuKQoKICAgIEV4YW1wbGUgZm9yIHJlY3Vyc2lvbi4KICAgIGxldCAyeHAgKDogWzJ4cCB4XSBAIGlmICg9IHggMCkgMSBAICogMiBAIDJ4cCBAIC0geCAxKSAoMnhwIDMpCgogICAgbGV0IGZhY3QtcHJpbWl0aXZlICg6IFtmYWN0LXByaW0geCBhY2NdIEAgaWYgKD0geCAwKSBhY2MgQCBmYWN0LXByaW0gKC0geCAxKSAoKiB4IGFjYykpIEAKICAgIGxldCBmYWN0ICg6IFtudWxsIHhdIFtmYWN0LXByaW0geCAxXSBbZmFjdC1wcmltXSkgQAogICAgZmFjdCA1CioqLwoKZnVuY3Rpb24gaGFzVW5kZXIoc2V4cCkgewogIHJldHVybiBzZXhwID09PSAnXycgfHwgaXNMaXN0KHNleHApICYmIHNleHAuc29tZShoYXNVbmRlcik7Cn0KCmZ1bmN0aW9uIHJlcGxhY2VVbmRlcihzZXhwLCB3KSB7CiAgaWYgKGlzTGlzdChzZXhwKSkgcmV0dXJuIHNleHAubWFwKCh4KSA9PiByZXBsYWNlVW5kZXIoeCwgdykpOwogIHJldHVybiBzZXhwID09PSAnXycgPyB3IDogc2V4cDsKfQoKZnVuY3Rpb24gcHJlcHJvKGNvZGUpIHsgcmV0dXJuIHByZXByb18yKHByZXByb18xKGNvZGUpKTsgfQoKZnVuY3Rpb24gcHJlcHJvXzEoY29kZSkgewogIGlmIChpc0F0b21pYyhjb2RlKSkgcmV0dXJuIGNvZGU7CiAgY29uc3QgcGFydHMgPSBjb2RlLm1hcChwcmVwcm9fMSk7CgogIC8vIEhhbmRsZSBACiAgY29uc3Qgc3RhY2sgPSBbW11dOwogIGZvciAoY29uc3QgeSBvZiBwYXJ0cykgewogICAgaWYgKHkgIT09ICdAJykgc3RhY2tbc3RhY2subGVuZ3RoLTFdLnB1c2goeSk7CiAgICBlbHNlIHN0YWNrLnB1c2goW10pOwogIH0KICB3aGlsZShzdGFjay5sZW5ndGggPiAxKSB7CiAgICBjb25zdCB0YWlsID0gc3RhY2sucG9wKCk7CiAgICBjb25zdCBwcmV0YWlsID0gc3RhY2sucG9wKCk7CiAgICBjb25zdCBuZXd0YWlsID0gaGFzVW5kZXIocHJldGFpbCkgPyByZXBsYWNlVW5kZXIocHJldGFpbCwgdGFpbCkgOiBwcmV0YWlsLmNvbmNhdChbdGFpbF0pOwogICAgc3RhY2sucHVzaChuZXd0YWlsKTsKICB9CiAgcmV0dXJuIHN0YWNrWzBdOwoKICAvLyBIYW5kbGUgY29uZCA9PiBjYW4gcmVwbGFjZSB3aXRoIGlmCiAgLy8gSGFuZGxlIGFuZCwgb3IKICAvLyByZXR1cm4gcGFydHM7Cn0KCmZ1bmN0aW9uIHByZXByb18yKGNvZGUpIHsKICBpZiAoaXNBdG9taWMoY29kZSkpIHJldHVybiBjb2RlOwogIGNvbnN0IHBhcnRzID0gY29kZS5tYXAocHJlcHJvXzIpOwogIGlmIChwYXJ0c1swXSA9PT0gJ2FuZCcpIHsKICAgIGxldCBhbnMgPSB0cnVlOwogICAgZm9yIChsZXQgaSA9IHBhcnRzLmxlbmd0aC0xOyBpID49IDE7IGktLSkgewogICAgICBhbnMgPSBbJ2lmJywgcGFydHNbaV0sIGFucywgZmFsc2VdOwogICAgfQogICAgcmV0dXJuIGFuczsKICB9IGVsc2UgaWYgKHBhcnRzWzBdID09PSAnb3InKSB7CiAgICBsZXQgYW5zID0gZmFsc2U7CiAgICBmb3IgKGxldCBpID0gcGFydHMubGVuZ3RoLTE7IGkgPj0gMTsgaS0tKSB7CiAgICAgIGFucyA9IFsnaWYnLCBwYXJ0c1tpXSwgdHJ1ZSwgYW5zXTsKICAgIH0KICAgIHJldHVybiBhbnM7CiAgfSBlbHNlIHJldHVybiBwYXJ0czsKfQoKZnVuY3Rpb24gcGFyc2UgKGlucHV0KSB7CiAgLy8gUmV3cml0dGVuIHBhcnNlLgoKICBjb25zdCBzID0ge3Rva2VuczogW10sIGxhc3Q6IFtdLCBkZXB0aDogMH07CiAgY29uc3QgZmx1c2ggPSAoKSA9PiB7CiAgICBjb25zdCB0b2tlbiA9IHMubGFzdC5qb2luKCcnKS50cmltKCk7CiAgICBzLmxhc3QgPSBbXTsKICAgIGlmICh0b2tlbi5sZW5ndGggPiAwKSB7IHMudG9rZW5zLnB1c2godG9rZW4pOyB9CiAgfTsgICAgCgogIGZvciAoY29uc3QgYyBvZiBpbnB1dCkgewogICAgaWYgKHMuZGVwdGggPiAwKSB7CiAgICAgIHMubGFzdC5wdXNoKGMpOwogICAgICBpZiAoYyA9PT0gJ3snKSBzLmRlcHRoICsrOwogICAgICBlbHNlIGlmIChjID09PSAnfScpIHsKICAgICAgICBzLmRlcHRoIC0tOwogICAgICAgIGlmIChzLmRlcHRoIDw9IDApIGZsdXNoKCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoYyA9PT0gJ3snKSB7CiAgICAgIGZsdXNoKCk7IHMubGFzdC5wdXNoKGMpOyBzLmRlcHRoICsrOwogICAgfSBlbHNlIGlmIChjID09PSAnfScpIHsKICAgICAgcmV0dXJuIG51bGw7ICAgIC8vIFBhcnNpbmcgZXJyb3IKICAgIH0gZWxzZSBpZiAoJygpW10nLmluY2x1ZGVzKGMpKSB7CiAgICAgIGZsdXNoKCk7IHMubGFzdC5wdXNoKGMpOyBmbHVzaCgpOwogICAgfSBlbHNlIGlmICgnIFx0XG4nLmluY2x1ZGVzKGMpKSB7CiAgICAgIGZsdXNoKCk7CiAgICB9IGVsc2UgewogICAgICBzLmxhc3QucHVzaChjKTsKICAgIH0KICB9CiAgZmx1c2goKTsKCiAgaWYgKHMuZGVwdGggIT0gMCkgcmV0dXJuIG51bGw7ICAgLy8gUGFyc2luZyBlcnJvcgoKICBjb25zdCBzdGFjayA9IFtbXV07CiAgZm9yIChjb25zdCB0IG9mIHMudG9rZW5zKSB7CiAgICBpZiAoWydbJywgJygnXS5pbmNsdWRlcyh0KSkgc3RhY2sucHVzaChbXSk7CiAgICBlbHNlIGlmIChbJyknLCAnXSddLmluY2x1ZGVzKHQpKSB7CiAgICAgIGNvbnN0IHRhaWwgPSBzdGFjay5wb3AoKTsKICAgICAgaWYgKHN0YWNrLmxlbmd0aCA8PSAwKSByZXR1cm4gbnVsbDsKICAgICAgc3RhY2tbc3RhY2subGVuZ3RoIC0gMV0ucHVzaCh0YWlsKTsKICAgIH0gZWxzZSB7CiAgICAgIHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdLnB1c2godCk7CiAgICB9CiAgfQoKICBpZiAoc3RhY2subGVuZ3RoICE9PSAxKSByZXR1cm4gbnVsbDsKICByZXR1cm4gc3RhY2tbMF07Cn0KCmZ1bmN0aW9uIHBhcnNlT25lIChpbnB1dCkgewogIHJldHVybiBwYXJzZShpbnB1dCkgWzBdOwp9CgpmdW5jdGlvbiBwYXJzZUxlbmllbnQgKGlucHV0KSB7CiAgdHJ5IHsKICAgIHJldHVybiBwYXJzZShpbnB1dCk7CiAgfSBjYXRjaCAoZSkgewogICAgaWYgKGUgaW5zdGFuY2VvZiBTeW50YXhFcnJvcikgewogICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IGU7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBwYXJzZU9uZUxlbmllbnQgKGlucHV0KSB7CiAgY29uc3QgYW5zID0gcGFyc2VMZW5pZW50KGlucHV0KTsKICBpZiAoIWFucykgcmV0dXJuIG51bGw7CiAgcmV0dXJuIGFuc1swXTsKfQoKZnVuY3Rpb24gdHJhbnNsYXRlTGl0ZXJhbChleHByKSB7CiAgaWYgKGV4cHIgaW5zdGFuY2VvZiBBcnJheSkgewogICAgcmV0dXJuIGV4cHIubWFwKHRyYW5zbGF0ZUxpdGVyYWwpOwogIH0gZWxzZSBpZiAodHlwZW9mKGV4cHIpID09PSAnc3RyaW5nJykgewogICAgaWYgKGV4cHIubWF0Y2goL15bLV0/WzAtOV0rJC8pKSByZXR1cm4gQmlnSW50KGV4cHIpOwogICAgaWYgKFsndHJ1ZScsICdmYWxzZScsICdudWxsJ10uaW5jbHVkZXMoZXhwcikpIHJldHVybiB7J3RydWUnOiB0cnVlLCAnZmFsc2UnOiBmYWxzZSwgJ251bGwnOiBudWxsfVtleHByXTsKICAgIHJldHVybiBleHByOwogIH0gZWxzZSB7CiAgICByZXR1cm4gZXhwcjsKICB9Cn0KCmZ1bmN0aW9uIGRlZXBQYXJzZShpbnB1dCkgeyByZXR1cm4gdHJhbnNsYXRlTGl0ZXJhbChwYXJzZU9uZShpbnB1dCkpOyB9CmZ1bmN0aW9uIHByZXByb0RlZXBQYXJzZShpbnB1dCkgeyByZXR1cm4gcHJlcHJvKHRyYW5zbGF0ZUxpdGVyYWwocGFyc2VPbmUoaW5wdXQpKSk7IH0KCi8vLyBQZXJmb3JtcyBhIHNpbXBsZSBtYXRjaCBiZXR3ZWVuIHBhdHRlcm4gYW5kIHNleHAuCi8vLyBSZW1lbWJlciwgaXQgcmV0dXJucyBhbiBvYmplY3Qge3N1Y2Nlc3MsIG1hcH0sCi8vLyBhbmQgaW4gYSBib29sZWFuLCBvbmx5IGNoZWNrIGZvciAuc3VjY2VzcwpmdW5jdGlvbiBzaW1wbGVNYXRjaCAocGF0dGVybiwgc2V4cCwgdmFycyA9IG51bGwpIHsKICBjb25zdCBfaXNWYXIgPSAodmFycyA9PT0gbnVsbCkgPyBpc1ZhciA6ICgodikgPT4gdmFycy5pbmNsdWRlcyh2KSk7CgogIGlmIChfaXNWYXIgKHBhdHRlcm4pKSB7CiAgICByZXR1cm4ge3N1Y2Nlc3M6IHRydWUsIG1hcDogbmV3IE1hcChbW3BhdHRlcm4sIHNleHBdXSl9OwogIH0gZWxzZSBpZiAoaXNBdG9tIChwYXR0ZXJuKSkgewogICAgaWYgKGVxIChwYXR0ZXJuLCBzZXhwKSkgewogICAgICByZXR1cm4ge3N1Y2Nlc3M6IHRydWUsIG1hcDogbmV3IE1hcChbXSl9OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHtzdWNjZXNzOiBmYWxzZSwgY2F1c2U6IGAke3BhdHRlcm59IC0+ICR7c2V4cH0gYXRvbV9taXNtYXRjaGB9OwogICAgfQogIH0gZWxzZSB7CiAgICAvLyBpc0xpc3QKICAgIGlmIChpc0F0b20gKHNleHApKSB7CiAgICAgIHJldHVybiB7c3VjY2VzczogZmFsc2UsIGNhdXNlOiBgJHtwYXR0ZXJufSAtPiAke3NleHB9IGF0b21gfTsKICAgIH0gZWxzZSBpZiAocGF0dGVybi5sZW5ndGggIT09IHNleHAubGVuZ3RoKSB7CiAgICAgIHJldHVybiB7c3VjY2VzczogZmFsc2UsIGNhdXNlOiBgJHtwYXR0ZXJufSAtPiAke3NleHB9IGxlbmd0aF9taXNtYXRjaGB9OwogICAgfSBlbHNlIHsKICAgICAgdmFyIHRvdGFsTWF0Y2ggPSB7c3VjY2VzczogdHJ1ZSwgbWFwOiBuZXcgTWFwKFtdKX07CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGF0dGVybi5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IG1hdGNoID0gc2ltcGxlTWF0Y2ggKHBhdHRlcm5baV0sIHNleHBbaV0pOwogICAgICAgIGNvbWJpbmVNYXRjaCAodG90YWxNYXRjaCwgbWF0Y2gpOwogICAgICAgIGlmICghIHRvdGFsTWF0Y2guc3VjY2VzcykgewogICAgICAgICAgcmV0dXJuIHRvdGFsTWF0Y2g7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0b3RhbE1hdGNoOwogICAgfQogIH0KfQoKZnVuY3Rpb24gY29tYmluZU1hdGNoIChvbGRNYXRjaCwgbmV3TWF0Y2gpIHsKICBpZiAoISBvbGRNYXRjaC5zdWNjZXNzKSByZXR1cm47CiAgaWYgKCEgbmV3TWF0Y2guc3VjY2VzcykgewogICAgb2xkTWF0Y2guc3VjY2VzcyA9IGZhbHNlOwogICAgb2xkTWF0Y2guY2F1c2UgPSBuZXdNYXRjaC5jYXVzZTsKICAgIHJldHVybjsKICB9CiAgZm9yIChjb25zdCB4IG9mIG5ld01hdGNoLm1hcC5rZXlzICgpKSB7CiAgICBpZiAob2xkTWF0Y2gubWFwLmhhcyh4KSkgewogICAgICBpZiAoZXEob2xkTWF0Y2gubWFwLmdldCh4KSwgbmV3TWF0Y2gubWFwLmdldCh4KSkpIHsgLypnb29kKi8gfQogICAgICBlbHNlIHsKICAgICAgICBvbGRNYXRjaC5zdWNjZXNzID0gZmFsc2U7CiAgICAgICAgb2xkTWF0Y2guY2F1c2UgPSBgJHt4fSAtPiAke29sZE1hdGNoLm1hcC5nZXQoeCl9LCAke25ld01hdGNoLm1hcC5nZXQoeCl9YDsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIG9sZE1hdGNoLm1hcC5zZXQoeCwgbmV3TWF0Y2gubWFwLmdldCh4KSk7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiByZXBsYWNlQWxsIChzZXhwLCBtYXApIHsKICBpZiAoaXNBdG9tIChzZXhwKSkgewogICAgcmV0dXJuIG1hcC5oYXMgKHNleHApID8gbWFwLmdldChzZXhwKSA6IHNleHA7CiAgfSBlbHNlIHsKICAgIHJldHVybiBzZXhwLm1hcCAoKGNoaWxkKSA9PiByZXBsYWNlQWxsIChjaGlsZCwgbWFwKSk7CiAgfQp9CgovLy8gSWYgdHdvIHNleHBzIGFyZSBlcXVhbC4KZnVuY3Rpb24gZXEgKGEsIGIpIHsKICByZXR1cm4gc3RyKGEpID09PSBzdHIoYik7Cn0KCi8vIFNleHAgdG8gc3RyaW5nLgpmdW5jdGlvbiBzdHIgKG9iaikgewogIGlmIChpc0F0b21pYyhvYmopKSByZXR1cm4gYCR7b2JqfWA7CiAgZWxzZSBpZiAoaXNNYXAob2JqKSkgcmV0dXJuIGBbIW1hcCAke1suLi5vYmpdfV1gOwogIGVsc2UgcmV0dXJuICdbJyArIG9iai5tYXAgKHN0cikuam9pbignICcpICsgJ10nOwp9CgovLyBQcmV0dHktcHJpbnQKZnVuY3Rpb24gcHByaW50KG9iaiwgaW5kZW50ID0gJycsIGhhc0luZGVudCA9IGZhbHNlKSB7CiAgY29uc3QgYW5zID0gW107CiAgaWYgKGhhc0luZGVudCkgYW5zLnB1c2goaW5kZW50KTsKCiAgaWYgKGlzTGlzdChvYmopKSB7CiAgICBpZiAob2JqWzBdID09PSAnbm9kZScpIHsKICAgICAgYW5zLnB1c2goJ1snKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvYmoubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAoaSA+IDApIGFucy5wdXNoKCcgJyk7CgogICAgICAgIGNvbnN0IHRlcm0gPSBvYmpbaV0sIGlzU3VicyA9IChpID09PSBTdWJzKSAmJiBpc0xpc3QodGVybSkgJiYgdGVybS5sZW5ndGggPiAwOwogICAgICAgIGlmIChpc1N1YnMpIHsKICAgICAgICAgIGFucy5wdXNoKCdbXG4nKTsKICAgICAgICAgIGZvciAoY29uc3Qgc3ViIG9mIHRlcm0pIHsKICAgICAgICAgICAgYW5zLnB1c2gocHByaW50KHN1YiwgaW5kZW50ICsgJyAgJywgdHJ1ZSkpOwogICAgICAgICAgICBhbnMucHVzaCgnXG4nKTsKICAgICAgICAgIH0KICAgICAgICAgIGFucy5wdXNoKGluZGVudCArICddJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGFucy5wdXNoKHN0cih0ZXJtKSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGFucy5wdXNoKCddJyk7CiAgICB9IGVsc2UgYW5zLnB1c2goc3RyKG9iaikpOwogIH0gZWxzZSBhbnMucHVzaChzdHIob2JqKSk7CgogIHJldHVybiBhbnMuam9pbignJyk7Cn0KCmZ1bmN0aW9uIGhhc01lbWJlcihhcnIsIGVsZW0pIHsKICByZXR1cm4gYXJyLnNvbWUoKHgpID0+IGVxKHgsIGVsZW0pKTsKfQoKZnVuY3Rpb24gZGVsTWVtYmVyKGFyciwgZWxlbSkgewogIHJldHVybiBhcnIuZmlsdGVyKCh4KSA9PiAhZXEoeCwgZWxlbSkpOwp9CgpmdW5jdGlvbiBzZXRFcXVhbHMoQSwgQikgewogIGNvbnN0IGRlc2NyaWJlID0gKHNldCkgPT4gWy4uLiBuZXcgU2V0KHNldC5tYXAoc3RyKSldLnNvcnQoKTsKICByZXR1cm4gZXEoZGVzY3JpYmUoQSksIGRlc2NyaWJlKEIpKTsKfQoKZnVuY3Rpb24gX3NleHBXYWxrKHNleHAsIHByZWZpeCwgcHVzaFRvKSB7CiAgcHVzaFRvLnB1c2goW1suLi5wcmVmaXhdLCBzZXhwXSk7CgogIGlmIChpc0xpc3QgKHNleHApKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNleHAubGVuZ3RoOyBpKyspIHsKICAgICAgcHJlZml4LnB1c2goaSk7CiAgICAgIF9zZXhwV2FsayhzZXhwW2ldLCBwcmVmaXgsIHB1c2hUbyk7CiAgICAgIHByZWZpeC5wb3AoKTsKICAgIH0KICB9IGVsc2UgeyAgICB9Cn0KCmZ1bmN0aW9uIHNleHBXYWxrKHNleHApIHsKICBjb25zdCBwdXNoVG8gPSBbXTsKICBjb25zdCBwcmVmaXggPSBbXTsKICBfc2V4cFdhbGsgKHNleHAsIHByZWZpeCwgcHVzaFRvKTsKICByZXR1cm4gcHVzaFRvOwp9CgovLyBBdm9pZCB1c2luZyBzdGVwU3RhY2ssIGJ1dCB1c2UgYSBzaW1wbGUgY2FsbGluZyBzdHJ1Y3R1cmUuCgovKioKU3ludGF4CgooZm4gYTEgYTIgLi4uIGFOKSDih5IgZXZhbHVhdGUKKHNldCBYIFkpIOKHkiBzZXQsIGluIHRoZSBjdXJyZW50IGZ1bmN0aW9uIChzY29wZSkKKHVzZSBYKSDih5IgY29uc3VtZSBYIGFuZCByZXR1cm4gaXRzIHZhbHVlCig6IFthMSBhMiAuLi4gYU5dIFtjYXB0dXJlc10gQCBzdGVwMSBzdGVwMiAuLi4gc3RlcE4pIOKHkiBkbyBzdGVwMSwgLi4uLCBzdGVwTiwgcmV0dXJuIHJlc3VsdCBvZiBzdGVwTgooZG8gZTEgZTIgLi4uIGVOKQoKaWYsIGxvb3AgKGNoZWNrcyAnYnJlYWsnKSwgYW5kLCBvciwgIiciIOKGkiBzdGFuZGFyZCBtYWNyb3MKICoqLwoKZnVuY3Rpb24gbGlzcEV2YWx1YXRlIChvYmosIGVudiA9IG51bGwpIHsKICBlbnYgPSBlbnYgfHwge307CgogIGlmIChpc0xpc3Qob2JqKSkgewogICAgaWYgKG9iai5sZW5ndGggPT09IDApIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQoKICAgIGNvbnN0IFtoZWFkLCAuLi5hcmdzXSA9IG9iajsKCiAgICBpZiAoaGVhZCA9PT0gJ2lmJykgewogICAgICBjb25zdCBbYSwgYiwgY10gPSBhcmdzOwogICAgICBjb25zdCBjb25kID0gbGlzcEV2YWx1YXRlIChhLCBlbnYpOwogICAgICBpZiAoY29uZCkgcmV0dXJuIGxpc3BFdmFsdWF0ZSAoYiwgZW52KTsKICAgICAgZWxzZSByZXR1cm4gbGlzcEV2YWx1YXRlIChjLCBlbnYpOwogICAgfSBlbHNlIGlmIChoZWFkID09PSAnbG9vcCcpIHsKICAgICAgd2hpbGUgKDEpIHsKICAgICAgICBjb25zdCBbc3ViXSA9IGFyZ3M7CiAgICAgICAgbGlzcEV2YWx1YXRlIChzdWIsIGVudik7CiAgICAgICAgaWYgKGVudi5icmVhaykgYnJlYWs7CiAgICAgIH07CiAgICB9IGVsc2UgaWYgKGhlYWQgPT09ICdhbmQnKSB7CiAgICAgIGZvciAoY29uc3QgYSBvZiBhcmdzKSB7CiAgICAgICAgY29uc3QgdmFsID0gbGlzcEV2YWx1YXRlIChhLCBlbnYpOwogICAgICAgIGlmICh2YWwpIGNvbnRpbnVlOyBlbHNlIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSBpZiAoaGVhZCA9PT0gJ29yJykgewogICAgICBmb3IgKGNvbnN0IGEgb2YgYXJncykgewogICAgICAgIGNvbnN0IHZhbCA9IGxpc3BFdmFsdWF0ZSAoYSwgZW52KTsKICAgICAgICBpZiAodmFsKSByZXR1cm4gdHJ1ZTsgZWxzZSBjb250aW51ZTsKICAgICAgfQogICAgICByZXR1cm4gZmFsc2U7CiAgICB9IGVsc2UgaWYgKGhlYWQgPT09ICInIikgewogICAgICByZXR1cm4gYXJnc1swXTsKICAgIH0gZWxzZSBpZiAoaGVhZCA9PT0gJ3NldCcpIHsKICAgICAgY29uc3QgW2EsIGJdID0gYXJnczsKICAgICAgY29uc3QgdiA9IGxpc3BFdmFsdWF0ZSAoYiwgZW52KTsKICAgICAgZW52W2FdID0gdjsKICAgICAgcmV0dXJuIHY7CiAgICB9IGVsc2UgaWYgKGhlYWQgPT09ICd1c2UnKSB7CiAgICAgIGNvbnN0IFthXSA9IGFyZ3M7CiAgICAgIGNvbnN0IHYgPSBlbnZbYV07CiAgICAgIGRlbGV0ZSBlbnZbYV07CiAgICAgIHJldHVybiB2OwogICAgfSBlbHNlIGlmIChoZWFkID09PSAnZG8nKSB7CiAgICAgIGxldCB2ID0gbnVsbDsKICAgICAgZm9yIChjb25zdCBhIG9mIGFyZ3MpIHsKICAgICAgICB2ID0gbGlzcEV2YWx1YXRlIChhLCBlbnYpOwogICAgICAgIGNvbnNvbGUubG9nKCdhZnRlciBkby1ldmFsdWF0ZScsIGVudik7CiAgICAgIH0KICAgICAgcmV0dXJuIHY7CiAgICB9IGVsc2UgaWYgKGhlYWQgPT09ICc6JykgewogICAgICAvLyBDb25zdHJ1Y3RzIGEgZnVuY3Rpb24gYmxvY2ssIHdpdGggY2FwdHVyZXMuCiAgICAgIGxldCBwYXJhbXMsIGNhcHR1cmVzPVtdLCBib2R5OwogICAgICBpZiAoYXJncy5sZW5ndGggPT09IDIpIHsKICAgICAgICBbcGFyYW1zLCBib2R5XSA9IGFyZ3M7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgW3BhcmFtcywgY2FwdHVyZXMsIGJvZHldID0gYXJnczsKICAgICAgfQoKICAgICAgLy8gRmluZCBjdXJyZW50IGNhcHR1cmVzCiAgICAgIGNvbnN0IGNhcHR1cmVkVmFsdWVzID0gY2FwdHVyZXMubWFwICgoYSkgPT4gW2EsIGVudlthXV0pOwogICAgICByZXR1cm4gWyc6JywgcGFyYW1zLCBjYXB0dXJlZFZhbHVlcywgYm9keV07CiAgICB9IGVsc2UgaWYgKGhlYWQgPT09ICdtYXRjaCcpIHsKICAgICAgcmV0dXJuIGxpc3BNYXRjaCAoYXJncywgZW52KTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFVzdWFsIGZuIGFwcGxpY2F0aW9uCiAgICAgIGNvbnN0IFtlaGVhZCwgLi4uZWFyZ3NdID0gb2JqLm1hcCgoeCkgPT4gbGlzcEV2YWx1YXRlKHgsIGVudikpOwogICAgICByZXR1cm4gbGlzcEFwcGx5IChlaGVhZCwgZWFyZ3MpOwogICAgfQogIH0gZWxzZSBpZiAoaXNBdG9tIChvYmopKSB7CiAgICBpZiAob2JqLnN0YXJ0c1dpdGgoJ3t9J1swXSkpIHsKICAgICAgLy8gc3RyaW5nIGxpdGVyYWwKICAgICAgcmV0dXJuIG9iajsKICAgIH0gZWxzZSBpZiAoYXJpdHlbb2JqXSAhPT0gdW5kZWZpbmVkKSByZXR1cm4gb2JqOwogICAgZWxzZSBpZiAoZW52W29ial0gIT09IHVuZGVmaW5lZCkgcmV0dXJuIGVudltvYmpdOwogICAgZWxzZSByZXR1cm4gbnVsbDsKICB9IGVsc2UgewogICAgcmV0dXJuIG9iajsKICB9Cn0KCmZ1bmN0aW9uIGxpc3BBcHBseSAoaGVhZCwgYXJncykgewogIC8vIGhlYWQsIGFyZ3MgYXJlIGFscmVhZHkgZXZhbHVhdGVkCgogIGlmIChvcGVyYXRvcnNbaGVhZF0pIHsKICAgIGlmIChhcml0eVtoZWFkXSA9PT0gYXJncy5sZW5ndGggfHwgYXJpdHlbaGVhZF0gPT09ICdWQVJJQUJMRScpIHsKICAgICAgcmV0dXJuIG9wZXJhdG9yc1toZWFkXSguLi5hcmdzKTsKICAgIH0gZWxzZSByZXR1cm4gbnVsbDsgIC8vIFRPRE8gbWFrZSB0aGlzIG5vbi1zaWxlbnQKICB9IGVsc2UgaWYgKCEgaXNMaXN0IChoZWFkKSkgewogICAgcmV0dXJuIG51bGw7CiAgfSBlbHNlIHsKICAgIGNvbnN0IFtjbG4sIHBhcmFtcywgY2FwdHVyZWRWYWx1ZXMsIGJvZHldID0gaGVhZDsKCiAgICBpZiAoY2xuICE9PSAnOicpIHJldHVybiBudWxsOwoKICAgIGNvbnN0IHN1YkVudiA9IHt9OwogICAgLy8gYXNzaWduIGNhcHR1cmVkIHZhbHVlcwogICAgZm9yIChjb25zdCBbYSwgYl0gb2YgY2FwdHVyZWRWYWx1ZXMpIHN1YkVudlthXSA9IGI7CgogICAgLy8gYXNzaWduIHBhcmFtcwogICAgaWYgKGlzQXRvbSAocGFyYW1zKSkgc3ViRW52W3BhcmFtc10gPSBhcmdzOwogICAgZWxzZSB7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyYW1zLmxlbmd0aDsgaSsrKSBzdWJFbnZbcGFyYW1zW2ldXSA9IGFyZ3NbaV07CiAgICB9CgogICAgLy8gYXNzaWduIHNlbGYsIHRvIGNhcmUgZm9yIHJlY3Vyc2lvbgogICAgc3ViRW52WydmbiddID0gaGVhZDsKCiAgICAvLyBSdW4gaW4gc3ViRW52CiAgICBsZXQgdiA9IG51bGw7CiAgICBmb3IgKGNvbnN0IGEgb2YgYm9keSkgewogICAgICB2ID0gbGlzcEV2YWx1YXRlIChhLCBzdWJFbnYpOwogICAgfQogICAgcmV0dXJuIHY7CiAgfQp9CgpmdW5jdGlvbiBsaXNwTWF0Y2ggKGFyZ3MsIGVudikgewogIC8vIGEgbWF0Y2ggc3RhdGVtZW50LCB3aXRob3V0IHRoZSBoZWFkICJtYXRjaCIuCiAgLy8gYXJncyA9IFtvYmosIFtjYXNlMSwgcmVwbDFdLCBbY2FzZTIsIHJlcGwyXSwgLi4uLCBbY2FzZU4sIHJlcGxOXV0KCiAgaWYgKGFyZ3MubGVuZ3RoID09IDApIHJldHVybiBudWxsOwoKICBjb25zdCBbb2JqLCAuLi4gYXJyb3dzXSA9IGFyZ3M7CiAgY29uc3QgdmFsdWUgPSBsaXNwRXZhbHVhdGUob2JqLCBlbnYpOwoKICBmb3IgKGNvbnN0IGFyciBvZiBhcnJvd3MpIHsKICAgIGNvbnN0IFthLCBiXSA9IGFycjsKICAgIGNvbnN0IG0gPSBsaXNwTSAodmFsdWUsIGEsIGVudik7CiAgICBpZiAobSkgewogICAgICByZXR1cm4gbGlzcEV2YWx1YXRlIChiLCBsaXNwSm9pbkVudiAobSwgZW52KSk7CiAgICB9IGVsc2UgY29udGludWU7CiAgfQogIHJldHVybiBudWxsOwp9CgpmdW5jdGlvbiBsaXNwTSAodmFsdWUsIHBhdHRlcm4sIGVudikgewogIC8vIFJldHVybnMgYSBtYXAgaWYgaXQgbWF0Y2hlcywgb3RoZXJ3aXNlIG51bGw7CgogIGlmIChwYXR0ZXJuID09PSAnXycpIHJldHVybiB7fTsKCiAgaWYgKGlzQXRvbSAocGF0dGVybikpIHsKICAgIC8vIGp1c3QgbWF0Y2gKICAgIHJldHVybiB7W3BhdHRlcm5dOiB2YWx1ZX07CiAgfQoKICBpZiAoaXNBdG9taWMgKHBhdHRlcm4pKSB7CiAgICAvLyBtdXN0IGJlIGVxdWFsCiAgICBpZiAocGF0dGVybiA9PT0gdmFsdWUpIHJldHVybiB7fTsgZWxzZSByZXR1cm4gbnVsbDsKICB9CgogIC8vIFNob3VsZCBiZSBhIGxpc3QgZm9yIG5vdy4KICBpZiAoISBpc0xpc3QgKHBhdHRlcm4pKSByZXR1cm4gbnVsbDsKCiAgLy8gTGlzdAogIGlmIChwYXR0ZXJuLmxlbmd0aCA9PSAwKSB7CiAgICBpZiAoaXNMaXN0KHZhbHVlKSAmJiB2YWx1ZS5sZW5ndGggPT0gMCkgcmV0dXJuIHt9OyBlbHNlIHJldHVybiBudWxsOwogIH0KCiAgY29uc3QgW3BoLCAuLi5wYXJnc10gPSBwYXR0ZXJuOwoKICAvLyBDYXNlcyBvZiBhIGxpc3QgcGF0dGVybgogIGlmICghIGlzQXRvbSAocGgpKSByZXR1cm4gbnVsbDsKCiAgaWYgKHBoID09PSAnPScpIHsKICAgIGNvbnN0IHRhcmdldFZhbHVlID0gbGlzcEV2YWx1YXRlIChwYXJnc1swXSwgZW52KTsKICAgIGlmIChlcSAodGFyZ2V0VmFsdWUsIHZhbHVlKSkgcmV0dXJuIHt9OyBlbHNlIHJldHVybiBudWxsOwogIH0gZWxzZSBpZiAocGggPT09ICd2YXInKSB7CiAgICByZXR1cm4ge1twYXJnc1swXV06IHZhbHVlfTsKICB9IGVsc2UgaWYgKHBoID09PSAnbGlzdDonKSB7CiAgICBpZiAoIWlzTGlzdCAodmFsdWUpKSByZXR1cm4gbnVsbDsKICAgIC8vIGluLXBsYWNlIG1hdGNoaW5nLCBleGNlcHQgd2hlbiBvbmUgb2YgdGhlbSBpcyBhIHNwcmVhZAogICAgbGV0IHNwcmVhZEluZGV4ID0gLTE7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmIChpc0xpc3QocGFyZ3NbaV0pICYmIHBhcmdzW2ldWzBdID09PSAnc3ByZWFkJykgewogICAgICAgIC8vIHJlZ2lzdGVyIHNwcmVhZAogICAgICAgIGlmIChzcHJlYWRJbmRleCA8IDApIHNwcmVhZEluZGV4ID0gaTsgZWxzZSByZXR1cm4gbnVsbDsgLy8gcGF0dGVybiBmYWlscyBpZiBtdWx0aXBsZSBzcHJlYWRzCiAgICAgIH0KICAgIH0KICAgIGNvbnN0IGlzU3ByZWFkID0gc3ByZWFkSW5kZXggPj0gMDsKICAgIGlmICghaXNTcHJlYWQpIHsKICAgICAgaWYgKHBhcmdzLmxlbmd0aCAhPT0gdmFsdWUubGVuZ3RoKSByZXR1cm4gbnVsbDsKICAgICAgbGV0IG0gPSB7fTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHN1Yk0gPSBsaXNwTSAodmFsdWVbaV0sIHBhcmdzW2ldLCBlbnYpOwogICAgICAgIG0gPSBtZXJnZU1hdGNoZXMgKG0sIHN1Yk0pOwogICAgICAgIGlmICghbSkgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIG07CiAgICB9IGVsc2UgewogICAgICBpZiAocGFyZ3MubGVuZ3RoIC0gMSA+IHZhbHVlLmxlbmd0aCkgcmV0dXJuIG51bGw7CiAgICAgIGNvbnN0IHByZWZpeExlbmd0aCA9IHNwcmVhZEluZGV4OwogICAgICBjb25zdCBzdWZmaXhMZW5ndGggPSBwYXJncy5sZW5ndGggLSBzcHJlYWRJbmRleCAtIDE7CiAgICAgIC8vIE1hdGNoZXMgZWFjaCBwcmVmaXggd2l0aCBzdWZmaXgKICAgICAgbGV0IG0gPSB7fTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcmVmaXhMZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHN1Yk0gPSBsaXNwTSAodmFsdWVbaV0sIHBhcmdzW2ldLCBlbnYpOwogICAgICAgIG0gPSBtZXJnZU1hdGNoZXMgKG0sIHN1Yk0pOwogICAgICAgIGlmICghbSkgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdWZmaXhMZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHN1Yk0gPSBsaXNwTSAodmFsdWVbdmFsdWUubGVuZ3RoIC0gMSAtIGldLCBwYXJnc1twYXJncy5sZW5ndGggLSAxIC0gaV0sIGVudik7CiAgICAgICAgbSA9IG1lcmdlTWF0Y2hlcyAobSwgc3ViTSk7CiAgICAgICAgaWYgKCFtKSByZXR1cm4gbnVsbDsKICAgICAgfQogICAgICBjb25zdCBzdWJNID0gbGlzcE0gKAogICAgICAgIHZhbHVlLnNsaWNlIChwcmVmaXhMZW5ndGgsIHZhbHVlLmxlbmd0aCAtIHN1ZmZpeExlbmd0aCksCiAgICAgICAgcGFyZ3Nbc3ByZWFkSW5kZXhdWzFdLAogICAgICAgIGVudiwKICAgICAgKTsKICAgICAgbSA9IG1lcmdlTWF0Y2hlcyAobSwgc3ViTSk7CiAgICAgIHJldHVybiBtOwogICAgfQogIH0gZWxzZSBpZiAocGggPT09ICdmJykgewogICAgLy8gVE9ETyBsYXRlci4KICAgIC8vIGFwcGx5IGYgYmVmb3JlLCBhbmQgc2VlIGlmIGl0IHNhdGlzZmllcy4KICB9IGVsc2UgaWYgKHBoID09PSAnc2F0JykgewogIH0gZWxzZSBpZiAocGggPT09ICdhbmQnKSB7CiAgfSBlbHNlIGlmIChwaCA9PT0gJ29yJykgewogIH0gZWxzZSBpZiAocGggPT09ICdub3QnKSB7CiAgfSBlbHNlIGlmIChwaCA9PT0gJ2d1YXJkJykgewogIH0gZWxzZSByZXR1cm4gbnVsbDsKfQoKZnVuY3Rpb24gbGlzcEpvaW5FbnYgKGZpcnN0RW52LCBzZWNvbmRFbnYpIHsKICBjb25zdCBhbnMgPSB7fTsKICAvLyBmaXJzdEVudiB0YWtlcyBwcmlvcml0eSwgc28gaXQgbWF5IG92ZXJ3cml0ZSBzZWNvbmRFbnYhCiAgZm9yIChjb25zdCBlIG9mIFtzZWNvbmRFbnYsIGZpcnN0RW52XSkgewogICAgZm9yIChjb25zdCBrIG9mIE9iamVjdC5rZXlzKGUpKSB7CiAgICAgIGNvbnN0IHYgPSBlW2tdOwogICAgICBhbnNba10gPSB2OwogICAgfQogIH0KICByZXR1cm4gYW5zOwp9CgpmdW5jdGlvbiBtZXJnZU1hdGNoZXMgKG0xLCBtMikgewogIGlmICghbTEgfHwgIW0yKSByZXR1cm4gbnVsbDsKICBjb25zdCBhbnMgPSB7fTsKICBmb3IgKG0gb2YgW20xLCBtMl0pIHsKICAgIGZvciAoayBvZiBPYmplY3Qua2V5cyhtKSkgewogICAgICBpZiAoayBpbiBhbnMpIHsKICAgICAgICBpZiAoISBlcSAoYW5zW2tdLCBtW2tdKSkgcmV0dXJuIG51bGw7ICAvLyBtaXNtYXRjaAogICAgICAgIGVsc2Uge30gLy8gZG8gbm90aGluZwogICAgICB9IGVsc2UgewogICAgICAgIGFuc1trXSA9IG1ba107CiAgICAgIH0KICAgIH0KICB9CiAgcmV0dXJuIGFuczsKfQoKLy8gY29uc29sZS5sb2cobGlzcEV2YWx1YXRlKHByZXByb0RlZXBQYXJzZSgnKCsgMyA0KScpKSkKCi8vIFRoZSBmb2xsb3dpbmcgY29tbWVudGVkIGxpbmUgbXVzdCBiZSBrZXB0LCBiZWNhdXNlIGl0IGlzIHVzZWQgYnkgYnVpbGRfbGlzcF93b3JrZXIucHkgdG8gY3JlYXRlIGEgd29ya2VyLgoKb25tZXNzYWdlID0gKGUpID0+IHtjb25zdCBkYXRhID0gcHJlcHJvRGVlcFBhcnNlKGUuZGF0YSk7IHBvc3RNZXNzYWdlKHN0cihsaXNwRXZhbHVhdGUoZGF0YSkpKTt9Cg==';
